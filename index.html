<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Isu Globalisasi Dalam Budaya (Versi 2.1)</title>
<style>
  body { font-family:'Poppins',sans-serif; background:#efe8dd; color:#2f2b27; margin:0; padding:20px;}
  .container { max-width:900px; margin:auto; }
  .topic { background:#fffdf9; border-radius:10px; padding:18px; margin-bottom:20px; border:1px solid #dfd2bf; }
  h2 { color:#3f352d; margin-bottom:8px; }
  p { line-height:1.6; margin-bottom:12px; }
  .comments { background:#f7f3ee; border-radius:8px; padding:12px; min-height:60px; margin-bottom:12px;}
  .comment-box { background:#fdf8f2; border-radius:8px; padding:12px; display:flex; flex-direction:column; gap:8px; }
  input, textarea { padding:10px; border-radius:6px; border:1px solid #c8bdb1; background:#fffdfb; width:100%; }
  button { align-self:flex-end; background:linear-gradient(90deg,#FFD54F,#FFC107); border:none; color:#2f2f2f; padding:8px 16px; border-radius:6px; cursor:pointer; font-weight:600; box-shadow:0 4px 12px rgba(255,197,60,0.18);}
  
  .comment-thread { display: flex; flex-direction: column; gap: 10px; }
  .replies-container {
    margin-left: 25px;
    padding-left: 25px;
    border-left: 2px solid #e6dbcc;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .reply-box { display: none; padding-top: 10px; gap: 8px; flex-direction: column; }
  .reply-box textarea { rows: 2; font-size: 14px; }
  .reply-box button { padding: 6px 12px; font-size: 12px; }
  
  .single-comment { 
    background:#ffffff; 
    border-radius:8px; 
    padding:10px 12px; 
    box-shadow:0 1px 3px rgba(0,0,0,0.04);
    position: relative;
    padding-left: 60px;
    min-height: 40px;
  }
  .comment-avatar {
    position: absolute;
    left: 10px;
    top: 10px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #eee;
  }
  .comment-name { color:#3b3028; font-weight:600; margin-bottom:2px;}
  .comment-time { color:#7a6f63; font-size:12px;}
  .comment-text { margin-top: 4px; word-wrap: break-word; }

  .delete-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #f0e9e0;
    border: 1px solid #dcd1c2;
    color: #8a7c6c;
    border-radius: 50%;
    width: 22px;
    height: 22px;
    cursor: pointer;
    font-weight: 600;
    line-height: 20px;
    padding: 0;
    font-size: 14px;
    text-align: center;
  }
  .delete-btn:hover { background: #e6dbcc; color: #333; }

  .emoji-bar {
    margin-top: 10px;
    padding-top: 8px;
    border-top: 1px solid #f0e9e0;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
  }
  .emoji-btn {
    background: #f7f3ee;
    border: 1px solid #e6dbcc;
    border-radius: 10px;
    padding: 4px 8px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
  }
  .emoji-btn:hover { background: #e6dbcc; border-color: #d6b984; }
  .emoji-count { font-size: 12px; color: #3b3028; font-weight: 600; margin-left: 4px; min-width: 10px; }
  
  .reply-btn {
    background: none;
    border: none;
    color: #7a6f63;
    font-weight: 600;
    cursor: pointer;
    font-size: 13px;
    padding: 4px 8px;
    margin-left: auto; 
  }
  .reply-btn:hover { text-decoration: underline; }
  
  #auth-container {
    background: #fffdf9;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
    text-align: center;
    border: 1px solid #dfd2bf;
  }
  #user-info { display: flex; align-items: center; justify-content: center; gap: 15px; }
  #user-info img { width: 40px; height: 40px; border-radius: 50%; }
  #user-info span { font-weight: 600; font-size: 16px; }
  #btn-logout { background: #d3c4b1; color: #333; margin-left: auto; }
  #btn-google-login { background: #4285F4; color: white; font-weight: 600; padding: 10px 16px; }
  textarea:disabled, button:disabled {
    background-color: #f7f3ee !important;
    opacity: 0.6;
    cursor: not-allowed;
  }
</style>
</head>
<body>
<div class="container">
  
  <div id="auth-container">
    <button id="btn-google-login" onclick="signInWithGoogle()">Login dengan Google</button>
    <div id="user-info" style="display:none;">
      <img id="user-avatar" src="" alt="Avatar">
      <span id="user-name"></span>
      <button id="btn-logout" onclick="signOut()">Logout</button>
    </div>
  </div>

  <h1 style="text-align:center;">üí¨ Isu Globalisasi Dalam Budaya</h1>
  <p style="text-align:center;">Baca perbincangan di bawah mengikut topik, kemudian tambah pendapat anda.</p>

  <div class="topic" id="topic1">
    <h2>üëó Pakaian Moden: Fesyen Ke atau Dah Lupa Aurat?</h2>
    <p>Sekarang semua nak nampak bergaya ‚Äî ikut tren, artis, dan influencer. Tapi dalam kejar fesyen moden, ramai dah lupa batas aurat dan kesopanan yang Islam ajar. Kita bangga ikut gaya Barat sebab nampak <i>‚Äútrendy‚Äù</i> dan <i>‚Äúup to date‚Äù</i>, tapi dalam masa sama maruah dan identiti Islam makin hilang.</p>
    <div class="comment-box">
      <textarea id="input-topic1" rows="3" placeholder="Sila login untuk komen..."></textarea>
      <button id="btn-topic1" onclick="postRootComment('topic1')">Hantar Komen</button>
    </div>
    <div id="comments-topic1" class="comments"></div>
  </div>

  <div class="topic" id="topic2">
    <h2>üíç Perkahwinan Bebas Anak: Kebebasan Atau Hilang Arah?</h2>
    <p>Semakin ramai pasangan pilih kahwin tanpa anak. Katanya nak fokus kerjaya, nak <i>‚Äúenjoy hidup‚Äù</i>, atau takut anak jadi beban. Pemikiran ni datang dari budaya Barat yang utamakan kebebasan diri. Tapi dalam Islam, anak itu rezeki dan amanah. Bila kita tolak zuriat, kita tolak tanggungjawab yang Allah beri.</p>
    <div class="comment-box">
      <textarea id="input-topic2" rows="3" placeholder="Sila login untuk komen..."></textarea>
      <button id="btn-topic2" onclick="postRootComment('topic2')">Hantar Komen</button>
    </div>
    <div id="comments-topic2" class="comments"></div>
  </div>

  <div class="topic" id="topic3">
    <h2>üë´ Pergaulan Bebas: Dah Biasa Sebab Dunia Dah Terbuka?</h2>
    <p><i>‚ÄúKawan je pun.‚Äù</i> ‚Äî ayat paling biasa bila sebut pergaulan bebas. Tapi bila batas makin kabur, dosa jadi hal kecil. Budaya Barat buat semua tu nampak normal, padahal Islam dah tetapkan batas untuk jaga maruah. Dunia boleh terbuka, tapi jangan sampai prinsip Islam kita terbuka sama.</p>
    <div class="comment-box">
      <textarea id="input-topic3" rows="3" placeholder="Sila login untuk komen..."></textarea>
      <button id="btn-topic3" onclick="postRootComment('topic3')">Hantar Komen</button>
    </div>
    <div id="comments-topic3" class="comments"></div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-auth-compat.js"></script>

<script>
// === FIREBASE CONFIG AWAK (DAH SIAP GANTI!) ===
const firebaseConfig = {
  apiKey: "AIzaSyBqlGP3LrsHeS0MIJsw1b8zgYGV4KtS4R8",
  authDomain: "isu-globalisasi-budaya-comment.firebaseapp.com",
  databaseURL: "https://isu-globalisasi-budaya-comment-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "isu-globalisasi-budaya-comment",
  storageBucket: "isu-globalisasi-budaya-comment.appspot.com",
  messagingSenderId: "884609318165",
  appId: "1:884609318165:web:1740573c3ae6668208bd1c"
};
// ============================================

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth(); 

const ALLOWED_EMOJIS = ['üëç', '‚ù§Ô∏è', 'üòÇ', 'üòÆ'];
let currentUser = null; 

// === 1. FUNGSI AUTENTIKASI (YANG HILANG TADI) ===

auth.onAuthStateChanged(user => {
  const loginButton = document.getElementById('btn-google-login');
  const userInfoDiv = document.getElementById('user-info');
  const allRootTextAreas = document.querySelectorAll('.comment-box textarea');
  const allRootButtons = document.querySelectorAll('.comment-box button');

  if (user) {
    currentUser = user;
    loginButton.style.display = 'none';
    userInfoDiv.style.display = 'flex';
    document.getElementById('user-avatar').src = user.photoURL;
    document.getElementById('user-name').textContent = user.displayName;
    
    allRootTextAreas.forEach(ta => {
      ta.disabled = false;
      ta.placeholder = "Tulis pendapat anda...";
    });
    allRootButtons.forEach(btn => btn.disabled = false);

  } else {
    currentUser = null;
    loginButton.style.display = 'block';
    userInfoDiv.style.display = 'none';
    
    allRootTextAreas.forEach(ta => {
      ta.disabled = true;
      ta.placeholder = "Sila login untuk komen...";
    });
    allRootButtons.forEach(btn => btn.disabled = true);
  }
  ['topic1','topic2','topic3'].forEach(loadComments);
});

function signInWithGoogle() {
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider).catch(error => {
    console.error("Gagal login:", error);
  });
}

function signOut() {
  auth.signOut();
}

function escapeHtml(unsafe){
  return unsafe ? unsafe.replace(/&/g,"&amp;").replace(/</g,"&lt;")
               .replace(/>/g,"&gt;").replace(/"/g,"&quot;")
               .replace(/'/g,"&#039;") : '';
}
// === TAMAT FUNGSI AUTENTIKASI ===


// === 2. FUNGSI UTAMA (Struktur Baru) ===

function postRootComment(topicId){
  const input = document.getElementById(`input-${topicId}`);
  const text = input.value.trim();
  
  if(!text) { alert('Sila tulis komen dahulu.'); return; }
  if(!currentUser) { alert('Sila login dahulu.'); return; }
  
  const commentData = {
    text: text,
    time: Date.now(),
    name: currentUser.displayName,
    photoURL: currentUser.photoURL,
    uid: currentUser.uid,
    parentId: "root",
    isDeleted: false
  };
  
  db.ref('comments/'+topicId).push(commentData);
  input.value='';
}

function postReply(topicId, parentId) {
  const input = document.getElementById(`textarea-reply-${parentId}`);
  const text = input.value.trim();
  
  if(!text) { alert('Sila tulis balasan dahulu.'); return; }
  if(!currentUser) { alert('Sila login dahulu.'); return; }
  
  const commentData = {
    text: text,
    time: Date.now(),
    name: currentUser.displayName,
    photoURL: currentUser.photoURL,
    uid: currentUser.uid,
    parentId: parentId,
    isDeleted: false
  };
  
  db.ref('comments/'+topicId).push(commentData);
  toggleReplyBox(parentId, false);
}

function toggleReplyBox(commentId, forceShow = null) {
  const replyBox = document.getElementById(`reply-box-${commentId}`);
  if (replyBox) {
    if (forceShow === false) {
      replyBox.style.display = 'none';
      document.getElementById(`textarea-reply-${commentId}`).value = '';
    } else if (forceShow === true) {
      replyBox.style.display = 'flex';
      document.getElementById(`textarea-reply-${commentId}`).focus();
    } else {
      const isVisible = replyBox.style.display === 'flex';
      replyBox.style.display = isVisible ? 'none' : 'flex';
      if (!isVisible) {
        document.getElementById(`textarea-reply-${commentId}`).focus();
      }
    }
  }
}

// === FIX 1: FUNGSI DELETE (HARD DELETE / PADAM TERUS) ===
function deleteComment(topicId, commentId) {
  if (!confirm('Anda pasti nak padam komen ini? SEMUA balasan di bawahnya akan turut dipadam.')) return;
  if (!currentUser) { alert('Sila login.'); return; }

  const commentRef = db.ref(`comments/${topicId}/${commentId}`);
  
  commentRef.once('value', snapshot => {
    const data = snapshot.val();
    if (!data) {
        console.log("Komen dah tak wujud.");
        return;
    }
    
    if (data.uid === currentUser.uid) {
        deleteAllReplies(topicId, commentId, () => {
            commentRef.remove()
                .catch(err => alert('Gagal padam komen utama: ' + err.message));
        });
        
    } else {
      alert('Anda hanya boleh padam komen anda sendiri.');
    }
  });
}

function deleteAllReplies(topicId, parentId, onComplete) {
    const repliesRef = db.ref('comments/' + topicId).orderByChild('parentId').equalTo(parentId);
    
    repliesRef.once('value', snapshot => {
        const replies = snapshot.val();
        if (!replies) {
            onComplete();
            return;
        }

        const replyIds = Object.keys(replies);
        let processedCount = 0;

        if (replyIds.length === 0) {
            onComplete();
            return;
        }

        replyIds.forEach(replyId => {
            deleteAllReplies(topicId, replyId, () => {
                db.ref(`comments/${topicId}/${replyId}`).remove(() => {
                    processedCount++;
                    if (processedCount === replyIds.length) {
                        onComplete();
                    }
                });
            });
        });
    });
}
// === TAMAT FIX 1 ===

function addReaction(topicId, commentId, emoji) {
  if (!currentUser) { alert('Sila login untuk react.'); return; }
  const reactionRef = db.ref(`comments/${topicId}/${commentId}/reactions/${emoji}`);
  reactionRef.transaction(currentValue => {
    return (currentValue || 0) + 1;
  });
}

// === FIX 2: FUNGSI 'LOAD' (SEMBUNYI KOMEN LAMA) ===
function loadComments(topicId){
  const container = document.getElementById('comments-'+topicId);
  
  db.ref('comments/'+topicId).orderByChild('time').on('value', snapshot => {
    container.innerHTML = ''; 
    const allComments = snapshot.val() || {};
    
    const commentsById = new Map();
    const repliesMap = new Map();
    
    for (const [id, comment] of Object.entries(allComments)) {
      comment.id = id; 
      commentsById.set(id, comment);
      
      const parentId = comment.parentId; 
      
      if (parentId) { // HANYA proses komen jika ia ADA 'parentId'
        if (!repliesMap.has(parentId)) {
          repliesMap.set(parentId, []);
        }
        repliesMap.get(parentId).push(comment);
      }
    }

    const rootComments = (repliesMap.get('root') || []).reverse();
    
    if (rootComments.length === 0) {
        container.innerHTML = '<p style="text-align:center; color:#777; font-size:14px;">Tiada komen lagi. Jadilah yang pertama!</p>';
    } else {
        const threadContainer = document.createElement('div');
        threadContainer.className = 'comment-thread';
        
        for (const comment of rootComments) {
          threadContainer.appendChild(
            renderCommentRecursive(topicId, comment, repliesMap, commentsById)
          );
        }
        container.appendChild(threadContainer);
    }
  });
}

function renderCommentRecursive(topicId, comment, repliesMap, commentsById) {
  const wrapper = document.createElement('div');
  wrapper.className = 'comment-wrapper';
  
  const div = document.createElement('div');
  div.className = 'single-comment';
  
  if (comment.isDeleted) { 
    div.classList.add('comment-deleted');
  }
  
  const date = new Date(comment.time);
  const timeStr = date.toLocaleString('ms-MY',{year:'numeric',month:'short',day:'numeric',hour:'numeric',minute:'2-digit'});
  const avatar = comment.photoURL || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
  
  let deleteBtnHtml = '';
  if (currentUser && currentUser.uid === comment.uid && !comment.isDeleted) {
    deleteBtnHtml = `<button class="delete-btn" onclick="deleteComment('${topicId}', '${comment.id}')">X</button>`;
  }

  let emojiBarHtml = '<div class="emoji-bar">';
  const reactions = comment.reactions || {}; 
  for (const emoji of ALLOWED_EMOJIS) {
    const count = reactions[emoji] || 0; 
    emojiBarHtml += `
      <button class="emoji-btn" onclick="addReaction('${topicId}', '${comment.id}', '${emoji}')">
        ${emoji} <span class="emoji-count">${count}</span>
      </button>
    `;
  }
  
  if (currentUser && !comment.isDeleted) {
    emojiBarHtml += `
      <button class="reply-btn" onclick="toggleReplyBox('${comment.id}')">
        Balas
      </button>
    `;
  }
  emojiBarHtml += '</div>';
  
  const replyBoxHtml = `
    <div class="reply-box" id="reply-box-${comment.id}">
      <textarea id="textarea-reply-${comment.id}" rows="2" placeholder="Membalas kepada ${escapeHtml(comment.name)}..."></textarea>
      <button onclick="postReply('${topicId}', '${comment.id}')">Hantar Balasan</button>
    </div>
  `;

  div.innerHTML = `
    <img src="${avatar}" alt="Avatar" class="comment-avatar">
    ${deleteBtnHtml}
    <div class="comment-name">${escapeHtml(comment.name)}</div>
    <div class="comment-time">${timeStr}</div>
    <div class="comment-text">${escapeHtml(comment.text)}</div>
    ${emojiBarHtml}
  `;
  
  wrapper.appendChild(div);
  wrapper.appendChild(new DOMParser().parseFromString(replyBoxHtml, 'text/html').body.firstChild);

  const replies = (repliesMap.get(comment.id) || []).reverse(); 
  if (replies.length > 0) {
    const repliesContainer = document.createElement('div');
    repliesContainer.className = 'replies-container';
    
    for (const reply of replies) {
      repliesContainer.appendChild(
        renderCommentRecursive(topicId, reply, repliesMap, commentsById)
      );
    }
    wrapper.appendChild(repliesContainer);
  }
  
  return wrapper;
}
// === TAMAT FIX 2 ===

// === 4. MULA! ===
// Tak perlu panggil loadComments() di sini, ia akan dipanggil oleh onAuthStateChanged
</script>
</body>
</html>




